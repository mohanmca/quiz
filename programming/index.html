<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Quiz Platform</title>
    <!-- SurveyJS CSS -->
    <link href="https://unpkg.com/survey-core@1.11.5/defaultV2.min.css" rel="stylesheet">
    <!-- Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Prism.js for enhanced code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-vsc-dark-plus.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="./css/quiz-platform.css" rel="stylesheet">
    
    <!-- SurveyJS and jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.11.5/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-jquery-ui@1.11.5/survey-jquery-ui.min.js"></script>
    
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <!-- Prism.js for enhanced code highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    
    <!-- Custom JavaScript - Load in correct order -->
    <script src="./js/quiz-platform.js"></script>
    <script src="./js/quiz-data-manager.js"></script>
    <script src="./js/quiz-ui-manager.js"></script>
    <script src="./js/quiz-manager.js"></script>
</head>
<body class="bg-light">
    <!-- Back to Home Button (hidden initially) -->
    <button id="backBtn" class="back-btn" style="display: none;" onclick="NavigationManager.showHomePage()">
        ‚Üê Back to Home
    </button>
    
    <!-- Stop Quiz Button (hidden initially) -->
    <button id="stopQuizBtn" class="stop-quiz-btn" style="display: none;" onclick="QuizManager.stopQuizAndShowProgress()">
        üõë Stop Quiz
    </button>
    
    <!-- Home Page -->
    <div id="homePage">
        <div class="platform-header text-center">
            <div class="container">
                <h1 class="display-4 mb-3">üéì Technical Quiz Platform</h1>
                <p class="lead">Test your knowledge across different programming languages and technologies</p>
            </div>
        </div>
        
        <div class="container">
            <div class="row" id="categoryGrid">
                <!-- Category cards will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Category Page -->
    <div id="categoryPage" style="display: none;">
        <div class="platform-header text-center">
            <div class="container">
                <div class="breadcrumb-nav d-inline-block mb-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="NavigationManager.showHomePage()">üè† Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page" id="categoryBreadcrumb">Category</li>
                        </ol>
                    </nav>
                </div>
                <h1 class="display-4 mb-3" id="categoryTitle">Category</h1>
                <p class="lead" id="categoryDescription">Explore quizzes in this category</p>
            </div>
        </div>
        
        <div class="container">
            <div class="row" id="subcategoryGrid">
                <!-- Subcategory cards will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Quiz List Page -->
    <div id="quizListPage" style="display: none;">
        <div class="platform-header text-center">
            <div class="container">
                <div class="breadcrumb-nav d-inline-block mb-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="NavigationManager.showHomePage()">üè† Home</a></li>
                            <li class="breadcrumb-item"><a href="#" onclick="NavigationManager.showCategory(platformState.currentCategory)" id="categoryBreadcrumbLink">Category</a></li>
                            <li class="breadcrumb-item active" aria-current="page" id="subcategoryBreadcrumb">Subcategory</li>
                        </ol>
                    </nav>
                </div>
                <h1 class="display-4 mb-3" id="quizListTitle">Quizzes</h1>
                <p class="lead" id="quizListDescription">Select a quiz to begin</p>
            </div>
        </div>
        
        <div class="container">
            <div class="row" id="quizGrid">
                <!-- Quiz cards will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Quiz Page -->
    <div id="quizPage" style="display: none;">
        <div class="container mt-4">
            <div id="surveyContainer" class="custom-scrollbar"></div>
        </div>
    </div>

    <script>
        // Add a timeout mechanism for initialization
        let initializationTimeout;
        let initializationStarted = false;
        
        // Initialize the platform when the page loads
        $(document).ready(async function() {
            try {
                // Set a timeout to catch stuck initialization
                initializationTimeout = setTimeout(() => {
                    if (!initializationStarted) {
                        console.error('Initialization timeout - external scripts may not have loaded');
                        showInitializationError('Initialization timed out. Please check that all JavaScript files are available and refresh the page.');
                    }
                }, 10000); // 10 second timeout
                
                // Check if required classes are available
                if (typeof Logger === 'undefined' || typeof DataManager === 'undefined') {
                    throw new Error('Required JavaScript modules not loaded. Please ensure all script files are accessible.');
                }
                
                initializationStarted = true;
                Logger.info('Starting platform initialization...');
                
                // Load and organize surveys
                await DataManager.loadAvailableSurveys();
                DataManager.organizeSurveysByCategory();
                
                // Display category cards
                if (typeof UIManager !== 'undefined') {
                    UIManager.displayCategoryCards();
                } else {
                    throw new Error('UIManager not loaded');
                }
                
                clearTimeout(initializationTimeout);
                Logger.info('Platform initialization completed successfully');
                
            } catch (error) {
                clearTimeout(initializationTimeout);
                console.error('Platform initialization failed:', error);
                
                showInitializationError(error.message);
            }
        });
        
        function showInitializationError(errorMessage) {
            const errorHtml = `
                <div class="alert alert-danger">
                    <h4>Platform Initialization Failed</h4>
                    <p>Failed to initialize the quiz platform. Please check the following:</p>
                    <ul>
                        <li>All JavaScript files are properly loaded</li>
                        <li>surveys.json file is accessible</li>
                        <li>You are running from a web server (not file:// protocol)</li>
                    </ul>
                    <p><strong>Error:</strong> ${errorMessage}</p>
                    <div class="mt-3">
                        <button class="btn btn-primary me-2" onclick="window.location.reload()">üîÑ Retry</button>
                        <button class="btn btn-secondary" onclick="console.log('Debug info:', {Logger: typeof Logger, DataManager: typeof DataManager, UIManager: typeof UIManager, NavigationManager: typeof NavigationManager, QuizManager: typeof QuizManager, Survey: typeof Survey, $: typeof $})">üêõ Debug Info</button>
                        <button class="btn btn-info" onclick="debugUI()">üîç Debug UI</button>
                    </div>
                </div>
            `;
            
            try {
                document.getElementById('categoryGrid').innerHTML = errorHtml;
            } catch (uiError) {
                alert('Critical error: Platform failed to initialize. Please refresh the page.\n\nError: ' + errorMessage);
            }
        }
        
        // Add debugging function
        function debugUI() {
            console.log('=== UI DEBUG INFO ===');
            console.log('Current page visibility:');
            console.log('- homePage:', document.getElementById('homePage').style.display);
            console.log('- categoryPage:', document.getElementById('categoryPage').style.display);
            console.log('- quizListPage:', document.getElementById('quizListPage').style.display);
            console.log('- quizPage:', document.getElementById('quizPage').style.display);
            
            const surveyContainer = document.getElementById('surveyContainer');
            console.log('Survey container:');
            console.log('- innerHTML length:', surveyContainer.innerHTML.length);
            console.log('- first 200 chars:', surveyContainer.innerHTML.substring(0, 200));
            console.log('- child nodes:', surveyContainer.children.length);
            
            console.log('SurveyJS elements:');
            console.log('- .sv-root:', document.querySelectorAll('.sv-root').length);
            console.log('- .sd-root:', document.querySelectorAll('.sd-root').length);
            
            console.log('Platform state:');
            console.log('- currentSurvey:', !!platformState.currentSurvey);
            console.log('- currentSurveyConfig:', !!platformState.currentSurveyConfig);
            console.log('- allQuestions length:', platformState.allQuestions?.length || 0);
            
            // Add visual debugging
            surveyContainer.classList.add('debug-container');
            setTimeout(() => surveyContainer.classList.remove('debug-container'), 3000);
        }
        
        // Make debugUI globally available
        window.debugUI = debugUI;
    </script>
</body>
</html>
